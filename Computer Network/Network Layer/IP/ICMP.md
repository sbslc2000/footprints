---
상위 링크: "[[IP]]"
---
# ICMP
\[RFC 792]에 정의된 인터넷 제어 메시지 프로토콜(Internet Control Message Protocol, ICMP)은 호스트와 라우터가 서로 간에 네트워크 계층 정보를 주고받기 위해 사용된다.

가장 전형적인 사용 형태는 오류 보고이다. 네트워크의 어떤 지점에서 IP 라우터가 명시된 주소로 가는 경로를 찾을 수 없는 경우, 라우터가 호스트에게 오류가 발생했음을 알리기 위해 ICMP 메시지를 만들어 보낸다.

ICMP는 종종 IP의 한 부분으로 간주되지만, ICMP 메시지가 IP 데이터그램에 담겨 전송되므로 구조적으로는 IP 바로 위에 있다. 즉 TCP나 UDP 세그먼트가 IP 페이로드로 전송되는 것처럼 ICMP 메시지도 IP 페이로드로 전송된다. IP의 동작을 보조하긴 제어 프로토콜이 IP와 별도의 프로토콜이면서 논리적으로는 IP의 부가 기능처럼 동작한다. 이렇게 데이터와 컨트롤을 분리함으로써 독립적으로 발전할 수 있게 만드는 기법을 out-of-band 기법이라고 한다.

## ICMP Message
![](https://i.imgur.com/QOa6YXx.png)

ICMP 메시지에는 타입(type)과 코드(code) 필드가 있고, ICMP 메시지의 발생 원인이 된 IP 데이터그램의 헤더와 첫 8 바이트를 갖는다. 만약 라우터가 경로를 찾을 수 없는 경우 송신자에게 타입은 3, 코드는 0인 메시지(Destination network unreachable)를 보낼 것이다.

## ping
'ping' 프로그램은 타입이 8, 코드가 0인 ICMP 메시지를 특정 호스트로 보낸다. 목적지 호스트는 에코 요청을 보고 나서 타입 0, 코드 0인 ICMP 에코 응답을 송신자에게 보낸다. ping은 이런 동작을 통해 발생하는 RTT를 출력한다. 대부분의 TCP/IP 구현은 ping 서버를 운영체제에서 직접 지원한다. 즉, ping 서버는 별도의 프로세스가 아니다.

## source quench message
ICMP 메시지 중 타입이 4이고 코드가 0인 메시지는 출발지 억제 메시지이다. 이는 실제로 사용되지 않는다. 이 메시지의 목적은 혼잡 제어를 위한 것이다. 혼잡이 발생한 라우터는 송신자에게 해당 메시지를 보내 호스트가 전송속도를 늦추도록 만든다(만드려고 했다).

## traceroute
traceroute는 출발지와 목적지 사이의 라우터 경로를 추적하는 프로그램이다. traceroute 역시 ICMP로 구현된다.

출발지와 목적지 사이의 라우터 이름과 주소를 알아내기 위해 출발지의 traceroute는 평범한 일련의 IP 데이터그램을 목적지에 보낸다. 이 데이터그램은 '없을 것 같은 포트의' UDP 세그먼트를 운반한다. 일련의 IP 데이터그램의 TTL값은 각각 1, 2, 3, ... 이런 식이다. 출발지는 각 데이터그램에 대해 타이머를 작동시킨다.

n번째 데이터그램이 n번째 라우터에 도착하면 해당 라우터는 데이터그램의 TTL이 만료되었음을 알게 된다. IP 프로토콜 규칙에 따라 라우터는 데이터그램을 폐기하고 ICMP 경고 메시지(타입 11, 코드 0)을 출발지에 보낸다. 이 경고 메시지는 라우터의 이름과 IP 주소를 포함한다. 이 ICMP 메시지가 출발지에 도착하면, 타이머로부터 RTT를 얻고, ICMP로부터 라우터 이름과 주소를 획득할 수 있다.

traceroute 출발지는 UDP 세그먼트 전송을 언제 멈춰야 하는지 어떻게 알까? TTL을 1 씩 증가시키며 보낸 데이터그램은 결국 목적지에 다다를 것이다. 목적지에 도착한 데이터그램은 UDP로 보내지며, 이곳에 작성된 포트는 '없을 것 같은' 포트이므로, 목적지 호스트는 포트 도달 불가능 ICMP 메시지(타입 3, 코드 3)을 출발지에 보낸다. 송신자가 이 메시지를 받게 되면 추가적인 탐색 패킷을 보낼 필요가 없음을 알게 된다.