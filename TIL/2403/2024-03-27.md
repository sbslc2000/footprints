# 설정 데이터 1 - 외부 파일
OS 환경 변수, 자바 시스템 속성, 커맨드 라인 옵션 인수는 사용해야하는 값이 늘어날 수록 사용하기가 불편해진다. 이에 대한 대안으로 설정값을 파일에 넣어서 관리할 수 있다.

![](https://i.imgur.com/rQA1pV0.png)

위 방법은 각각의 환경에 맞는 값을 가진 application.properties를 각각의 서버에 넣어두고, 애플리케이션 로딩 시점에 이 값들을 읽어서 외부 설정값으로 사용하는 방식이다.

## 스프링과 설정 데이터
스프링부트는 이 부분을 다 구현해두어서, 개발자는 application.properties라는 이름의 파일을 **자바를 실행하는 위치에 만들어주기만 하면** PropertySource에서 이를 읽어서 Environment에 넣어준다. 스프링에서는 이러한 파일을 설정 데이터*Config data*라고 한다.

![](https://i.imgur.com/57240gS.png)

하지만 이 경우 설정 파일이 각 서버에 분산되어 있어 관리가 어려워지는 문제가 있다. 또한 이 설정 파일은 git에 의해 이력이 추적되지 않기 때문에 변경 사항을 파악하기 어렵다.

# 설정 데이터2 - 내부 파일 분리
설정 파일을 외부에 관리하는 것은 상당히 번거롭다. 설정을 변경하기 위해서는 각각의 서버에 접속하여 변경사항을 수정해야하기 때문이다.

이 문제를 해결하는 간단한 방법은 설정 파일을 프로젝트 내부에 포함하여 관리하며 이를 빌드시점에 함께 적용되게 만드는 것이다. 이렇게 한다면 애플리케이션 배포 시점에 설정 파일을 변경사항도 함께 배포할 수 잇다.
![](https://i.imgur.com/24TT513.png)
이 경우 app.jar는 개발, 운영 두 설정파일을 모두 가지고 배포가 되며, 실행할 때 외부 설정을 통해 dev 혹은 prod 프로필을 넘겨주면 그에 맞는 설정파일을 읽어서 사용한다.

프로젝트 안에 설정 파일은 resources 폴더 하위에 넣으면 된다.

## 프로필
스프링은 프로필이라는 개념을 지원한다.
spring.profiles.active 외부 설정에 값을 넣으면 해당 프로필을 사용한다고 판단한다. 그리고 프로필에 따라서 다음과 같은 규칙으로 해당 프로필에 맞는 내부 파일(설정 데이터)를 조회한다.
`application-{prolfile}.properties`

ex)
`java -Dspring.profiles.active=dev -jar app.jar`
-> application-dev.properties를 설정 데이터로 사용

# 설정 데이터3 - 내부 파일 합체
설정 파일을 각각 분리해서 관리하면 한 눈에 전체가 들어오지 않는 단점이 있다. 스프링은 이런 단점을 보완하기 위해 물리적인 하나의 파일 안에서 논리적으로 영역을 구분하는 방법을 제공한다.
![](https://i.imgur.com/VWwcLp2.png)

properties 형식에서는 `#---` 또는 `!---`로 구분할 수 있고, yml의 경우 `---`로 구분해야한다. 이 때 프로필은 spring.config.activate.on-profile={profile}로 지정해주어야 한다.

또한 구분 기호에는 선행 공백이 없어야하고, 위 아래에 주석이 없어야 하며, 정확하게 3개의 하이픈만이 존재해야한다.

# 우선순위
프로그램을 실행할 때 프로필을 활성화하지 않는다면 스프링은 기본적으로 default라는 이름의 프로필을 활성화 시킨다.

## 기본값
내 PC에서 개발하는 것을 local 개발 환경이라고 하는데, 이 때에 매번 local 프로필을 지정해주는 것은 귀찮을지도 모른다 설정 데이터에는 기본값을 지정할 수 있으며, 이 기본값들은 프로필 지정과 무관하게 항상 적용된다.

```
url=local.db.com
username=local_user
password=local_pw
#---
spring.config.activate.on-profile=dev
url=dev.db.com
username=dev_user
password=dev_pw
```
위 경우 프로필 정보가 없는 local 정보가 설정 데이터로 사용된다.

### 모든 순서는 위에서 아래로
스프링은 설정데이터 문서를 위에서부터 아래로 읽어가며 값을 적용한다. 위 문서의 처음에 나오는 문서는 프로필 정보가 없으므로 프로필과 무관하게 읽어서 데이터로 사용한다.

만약 프로필에 dev가 지정되어있다면, 초기에 적용했던 기본값이 이후 dev를 읽는 과정에서 대체된다.

## 외부 설정 우선순위

자주 사용되는 외부 설정 순서는 아래와 같다.
1. 설정 데이터 (application.properties)
2. OS 환경 변수
3. 자바 시스템 속성
4. 커맨드 라인 옵션 인수
5. @TestPropertySource (테스트에서 사용)

설정 데이터에서의 자주 사용되는 순서는 아래와 같다.
1. jar 내부의 application.properties
2. jar 내부 프로필 적용 파일 application-{profile}.properties
3. jar 외부 application.properties
4. jar 외부 프로필 적용 파일 application-{profile}.properties

위 모든 방식에 따른 우선순위는 아래가 제일 높다.

* 더 유연한 것이 우선권을 가진다. (변경이 어려운 파일보다 실행시 원하는 값을 줄 수 있는 자바 시스템 속성이 더 우선권을 가진다.)
* 범위가 넓은 것 보다 좁은 것이 우선권을 가진다.
	* OS 환경변수보다 자바 시스템 속성이 우선권이 있다.
	* 자바 시스템 속성보다 커맨드 라인 옵션 인수가 우선권이 있다.

### 추가 또는 변경되는 방식
Environment를 통해서 조회하는 관점에서 보면 외부 설정값은 계속 추가되거나 기존 값을 덮어서 변경하는 것 처럼 보인다. 하지만 실제 값을 덮어서 변경하는 것은 아니고, 우선순위가 높은 값이 조회되는 것이다.



