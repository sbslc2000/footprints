---
상위 링크: "[[Spring]]"
---
# 프로덕션 준비 기능
'전투에서 실패한 지휘관은 용서할 수 있지만, 경계에서 실패하는 지휘관은 용서할 수 없다.' 라는 말이 있다. 장애는 언제든지 발생할 수 있지만, 모니터링(경계)는 잘 대응하는 것이 중요하다.

개발자가 애플리케이션을 개발할 때에는 기능 요구사항만 하는 것이 아니다. 서비스를 실제 운영 단계에 올리게 되면 개발자들이 해야하는 또 다른 주요한 업무가 있다. 바로 서비스에 문제가 없는지 모니터링하고 지표들을 심어서 감시하는 활동이다.

운영 환경에서 필요한 이런 기능들을 프로덕션 준비 기능이라고 한다. -- 프로덕션을 운영에 배포할 때 준비해야하는 비 기능적인 요소

* 지표(metric) : cpu 사용량 등
* 추적(trace) : 애플리케이션 코드가 어디서 문제가 되나, 어떤 루트로 호출이 되나
* 감사(auditing) : 로그인, 로그아웃 등의 이력
* 모니터링 : 전체적인 지표들에 대한 문제점들을 확인하는 행동

스프링부트가 제공하는 액츄에이터는 프로덕션 준비 기능을 편리하게 사용할 수 있는 다양한 편의 기능들을 제공한다. 더 나아가서 마이크로미터, 프로메테우스, 그라파나 같은 최근 유행하는 모니터링 시스템과 매우 쉽게 연동할 수 있는 기능도 제공한다.

# Actuator 시작하기
Actuator 의존성은 다음과 같이 추가한다.
```groovy
implementation 'org.springframework.boot:spring-boot-starter-actuator' 
```

이후 Main 클래스를 수행한 뒤 {host}/actuator 에 접속하면 다음과 같은 실행 결과를 볼 수 있다.
```java
{  
	"_links": {
	     "self": {
			"href": "http://localhost:8080/actuator",
	        "templated": false
	     },     
	     "health-path": {
			"href": "http://localhost:8080/actuator/health/{*path}",
		    "templated": true
	     },
	     "health": {
		    "href": "http://localhost:8080/actuator/health",
		    "templated": false
	    } 
	}
}
```

{host}/actuator/health에 접근하면 다음과 같은 결과를 볼 수 있다.
```java
{"status": "UP"}
```
status 값은 서버가 잘 동작하고 있는지 애플리케이션의 헬스 상태를 나타낸다.

현재 볼 수 있는 기능은 헬스 상태를 확인하는 기능 뿐인데, actuator를 통해 헬스 상태 뿐만 아니라 수 많은 기능을 제공한다.

```yaml
//application.yml
management:
   endpoints:
     web:
       exposure:
			include: "*" 
```

## 액츄에이터와 보안
### 보안 주의
액츄에이터가 제공하는 기능들은 우리 애플리케이션의 내부 정보를 너무 많이 노출한다. 그래서 외부 인터넷 망이 공개된 곳에 액츄에이터의 엔드포인트를 공개하는 것은 보안상 좋은 방안이 아니다.

액츄에이터의 엔드포인트들은 외부 인터넷에서 접근이 불가능하게 막고, 내부에서만 접근 가능한 내부망을 사용하는 것이 안전하다.

### 액츄에이터를 다른 포트에서 실행
예를 들어서 외부 인터넷 망을 통해서 8080 포트에만 접근할 수 있고, 다른 포트는 내부망에서만 접근할 수 있다면 액츄에이터에 다른 포트를 설정하면 된다. 액츄에이터의 기능을 애플리케이션 서버와는 다른 포트에서 실행하려면 다음과 같이 설정하면 되며, 이 경우 8080에서는 액츄에이터에 접근할 수 없다.

`management.server.port=9292`

만약 포트 분리가 어려운 상황이라면 /actuator 경로에 서블릿 필터, 스프링 인터셉터 또는 스프링 시큐리티를 통해서 인증된 사용자만 접근 가능하도록 추가 개발이 필요하다.

### 엔드포인트 경로 변경
엔드포인트의 기본 경로를 변경하려면 다음과 같이 설정하면 된다.
```yaml
managment:
	endpoints:
		web:
			base-path: "/manage"
```