---
상위 개념: "[[Log-based Recovery]]"
---
# Recovery Algorithm

## Transaction Rollback
시스템 장애 후 복구 과정이 아닌 정상적인 상황에서 트랜잭션 롤백은 다음과 같이 수행된다.

1. 로그를 역방향으로 스캔한다.
2. 스캔하며 만나게 되는 <$T_i, X_j, V_1, V_2$>에 대해
	1. 데이터 항목 $X_j$에 값 $V_1$을 기록한다. (이전 값)
	2. redo 전용 레코드 <$T_i$, $X_j$, $V_1$> 을 기록한다. 여기서 $V_1$은 복구된 값이다. 이러한 레코드를 보상 로그 레코드(compensation log record)라고 한다.
3. <$T_i$, start>를 만나면 역방향 탐색을 중단한다. 이후 <$T_i$, abort> 로그 레코드를 로그에 기록한다.

## Recovery After a system crash
장애 이후에 데이터베이스 시스템을 재시작할 때 다음 두 가지 단계를 거쳐 복구가 이루어진다. 이는 실패한 트랜잭션에 대해서도 다시 갱신을 수행하기에 비효율적으로 보일 수 있지만, 복구 기법을 단순하게 만드는 효과를 갖는다.

### redo 단계
이 단계는 재현(repeating history)라고도 부른다. redo 단계에서 시스템은 마지막 체크포인트부터 순방향으로 로그를 탐색하며 모든 트랜잭션의 갱신작업을 재실행한다. 이 과정에서 시스템 장애 이전에 롤백된 트랜잭션의 로그 레코드 역시 재실행된다.

또한 이 단계에서 장애가 발생한 시점에 완료하지 못하여 롤백해야하는 트랜잭션을 모두 찾아야 한다. 이들은 <$T_i$, abort> 나 <$T_i$, commit>을 갖고 있지 않은 트랜잭션들일 것이다.

롤백해야하는 트랜잭션은 undo-list로 관리한다. 순방향 탐색 시작지점에서 undo-list는 \<checkpoint L>에서 L로 초기화되며(체크포인트 시점에 미완료된 트랜잭션), <$T_i$, start>를 만나면 $T_i$를 추가하고, commit 혹은 abort 레코드를 만나면 해당 트랜잭션을 undo-list에서 삭제한다. 이 과정을 거치고 모든 레코드를 순회한다면, 마지막에 남은 undo-list의 트랜잭션은 장애 이전에 커밋하지 못했거나 롤백이 완료되지 못한 트랜잭션만 남는다.

### undo 단계
undo 단계에서 시스템은 undo-list에 있는 모든 트랜잭션을 롤백한다. 이 과정은 로그의 마지막부터 역방향 탐색으로 수행되어야 한다. undo 단계가 끝나면 일상적인 트랜잭션 처리를 다시 시작할 수 있다.
