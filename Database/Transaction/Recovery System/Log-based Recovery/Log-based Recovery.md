---
상위 개념: "[[../Recovery System|Recovery System]]"
---
# Log-based Recovery
로그 기반 복구(Log-based recovery)는 로그 레코드를 사용하여 트랜잭션 실패를 복구하고 원자성을 유지하는 방법이다.

트랜잭션이 쓰기 연산을 수행할 때마다 데이터베이스를 변경하기 전에 쓰기 연산을 위한 로그 레코드를 생성하고 로그에 추가해야 한다. 또한 데이터베이스에 이미 반영된 변경 사항을 로그 레코드에 기록된 이전 값을 이용하여 실행 취소 할 수 있다.

시스템 장애나 디스크 고장을 복구할 때 로그 레코드를 활요앟기 위해서 로그는 반드시 안정 저장 장치에 있어야 한다.

## Log Record
로그(Log)는 데이터베이스의 변경 사항을 기록하기 위해 가장 널리 사용되는 자료구조이다. 로그는 연속된 로그 레코드(log record)로 구성되며, 데이터베이스의 모든 갱신 작업을 기록한다.

### Update Log Record
갱신 로그 레코드(Update Log Record)는 하나의 데이터베이스 쓰기 연산을 기술하며, 다음과 같은 필드를 갖는다.

* 트랜잭션 식별자(transaction identifier)($T_i$): 쓰기 연산을 수행한 트랜잭션의 고유 식별자
* 데이터 항목 십결자(data-item identifier)($X_j$): 트랜잭션이 쓰기 연산을 수행한 데이터 항목의 고유 식별자이다. 일반적으로 데이터 항목의 디스크 상 위치를 사용하며, 해당 데이터 항목이 들어있는 블록의 블록 식별자와 블록 내의 오프셋으로 구성된다.
* 이전 값(old value)($V_1$): 쓰기 연산을 실행하기 전 데이터 항목의 값이다.
* 새로운 값(new value)($V_2$): 쓰기 연산을 실행한 이후 데이터 항목이 가질 값이다.

이를 <$T_i$, $X_j$, $V_1$, $V_2$> 로 나타내기도 한다.

### 특별한 로그 레코드

* <$T_i$, start> : 트랜잭션 $T_i$가 시작되었음을 의미
* <$T_i$ commit>: 트랜잭션 $T_i$가 커밋했음을 의미
* <$T_i$ abort>  : 트랜잭션 $T_i$가 중단되었음을 의미

## 데이터베이스 변경
로그 레코드는 트랜잭션을 취소할 때 트랜잭션이 수행한 변경 사항을 시스템이 되돌릴 수 있도록 해 준다. 또한 트랜잭션이 커밋하고 나서 변경 사항을 디스크에 반영하기 전에 시스템에 장애가 발생하더라도 트랜잭션의 변경 사항을 데이터베이스에 다시 반영할 수 있게 해준다.

트랜잭션이 데이터베이스를 수정한다는 것은 트랜잭션이 디스크 버퍼 또는 디스크 자체를 갱신하는 것을 말한다. 트랜잭션이 단순히 메인 메모리상의 개인 영역에서 데이터 항목을 수정한 것은 데이터베이스를 수정했다고 말하지 않는다.

데이터베이스 수정의 시점에 따라 지연 갱신 기법과 즉시 갱신 기법으로 나누어 볼 수 있다.

* 지연 갱신 기법(Deferred Modification): 트랜잭션이 커밋할 때까지 데이터베이스를 수정하지 않는 방식을 의미한다. 지연 갱신은 모든 갱신한 데이터 항목에 대해 로컬 사본을 유지해야하는 부담이 있다. 또한 데이터를 읽을 때에 만약 자신이 갱신했던 항목이라면 반드시 로컬 사본을 읽어야 한다.
* 즉시 갱신 기법(Immediate Modification): 트랜잭션이 수행하는 도중 데이터베이스 수정을 할 수 있는 방식을 의미한다.

모든 데이터베이스 변경은 반드시 로그 레코드를 생성한 후 진행해야하므로 시스템은 데이터 항목이 수정되기 이전의 값과 이후의 값을 알 수 있다. 이에 따라 undo와 redo라는 연산을 정의할 수 있다.

* undo는 로그 레코드를 사용해 로그 레코드에 명시도니 데이터 항목을 이전 값으로 변경하는 연산이다.
* redo는 로그 레코드를 사용해 로그 레코드에 명시된 데이터 항목을 새로운 값으로 변경하는 연산이다.

## 트랜잭션 커밋
트랜잭션의 마지막 로그 레코드인 커밋 로그 레코드가 안정 저장 장치에 기록되면 트랜잭션이 커밋했다고 한다. 이는 복구에 필요한 모든 레코드가 이미 안정 저장 장치에 기록되어 있어 다시 되돌릴 수 있는 충분한 정보를 갖게 된다.

## 트랜잭션 redo와 undo