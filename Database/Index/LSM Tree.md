---
상위 개념: "[[Index]]"
---
# Log-Structure Merge Tree
![](https://i.imgur.com/vzJsTuM.png)

LSM 트리는 쓰기 작업에서 효율적인 성능을 보장하기 위해 설계된 계층적 인덱스 구조이다.

## 구조
LSM 트리는 계층구조를 갖는 여러 개의 B+트리로 구성된다. $L_0$ 에 해당하는 트리는 인메모리에서 동작하며, 나머지 ($L_1, L_2, \ldots, L_k$) 는 디스크 상에 존재한다.

## 동작 원리
### 레코드 생성
모든 레코드의 생성은 인메모리에서 이루어진다. $L_0$ 트리에 값을 저장하다가, 더 이상 저장할 공간이 없어진다면 인메모리의 데이터를 디스크와 합쳐야 한다.

만약 $L_1$이 비어있는 경우, 인메모리의 데이터는 그대로 $L_1$에 복사된다. 만약 $L_1$에 이미 트리가 존재하는 경우, $L_0$과 $L_1$의 트리는 병합되어야 한다. 이 때 **상향식 구축 방식**이 사용된다.

상향식 구축 방식이란 두 서로 다른 B+트리를 합병하기 위해 source의 데이터를 target으로 하나하나 삽입하는 것이 아니라, 양 측의 데이터를 정렬하고 리프 노드 단위로 나눈 뒤 내부 노드를 연결해나가는 방식이다. 이렇게 합병함으로써 다음과 같은 이점을 얻을 수 있다.

1. 새로운 트리의 단말 노드는 순차적으로 배치되므로, 임의의 I/O를 방지할 수 있다.
2. 최종적으로 만들어진 트리가 단말 노드가 가득차게된 효율적인 구조를 가지며, 트리의 깊이를 최소화한다.

그러나 LSM 구조를 사용하는데는 $L_i$의 엔트리 집합이 $L_{i+1}$ 에 추가될 때마다 완전히 새로운 트리를 만들어야 한다는 추가 비용이 발생한다. 이 비용을 줄이기 위해 **단계별 합병 인덱스**(stepped-merge index)를 사용할 수 있다.

단계별 합병 인덱스는 인메모리 인덱스를 제외한 나머지 계층에서 여러 개의 B+트리를 유지하는 방법이다. 이 방법에서는 $L_0$이 꽉 찼고 $L_1$에 트리가 존재할 때, 둘을 바로 합병하지 않고 $L_0$의 트리를 디스크에 그냥 복사한다 ($L_1$의 트리는 2개가 된다). 이렇게 트리가 늘어나다가 특정 임계값에 다다르면 $L_1$의 여러 트리들을 하나의 $L_2$ 단계의 트리로 합병한다. 이렇게 만들어진 $L_2$의 트리도 매번 합병되지 않고 개수가 다 차면 합병된다. 이는 최대한 합병 작업을 미루고 한 번에 수행하게 만들어 오버헤드를 줄인다.

### 검색
인덱스 검색은 $L_0, \ldots, L_k$ 트리 각각에 별도의 검색 연산을 수행하고, 검색 결과를 합병하는 방식으로 수행된다. 하지만 여러 개의 B+트리에서 검색을 하는 행위는 비효율적일 수 있다. 특히 계층이 높은 트리일수록 높은 깊이에 의해 병목현상이 발생할 수 있다.

이러한 문제를 줄이기 위해서 **블룸 필터**(Bloom Filter)라고 부르는 비트맵 기반 구조를 사용하여 특정 트리에서 검색 키 존재 여부를 효율적으로 얻고 검색 수를 줄인다.

### 삭제
LSM 트리에서 삭제는 매우 흥미로운 방식으로 수행된다. B+트리에서 특정 인덱스 키 값을 찾아 삭제하는 대신, **삭제 엔트리**라는 B+트리에 삭제할 키 값을 추가한다. 이 과정은 일반적인 B+트리 인덱스에 값을 삽입하는 것과 동일하다.

검색은 일반 엔트리들과 삭제 엔트리를 동시에 수행하며, 최종 결과에서 일반 엔트리와 삭제 엔트리에 동일한 키 값이 존재한다면 해당 값은 검색 결과에 포함하지 않는다. 

삭제 엔트리는 해당 레이어의 인덱스들이 병합되는 과정에서 자연스레 검색 키를 제외하고 새로운 트리를 만든다.

### 갱신
갱신 역시 갱신 엔트리를 사용한다. 검색 결과는 갱신 엔트리의 내용이 우선적으로 적용되어 반환된다.

## 의의
LSM 트리는 원래 마그네틱 디스크의 쓰기와 검색 오버헤드를 줄이기 위해 설계되었지만, 플래시 기반 SSD는 임의 I/O 연산에 대한 오버헤드가 상대적으로 낮기 때문에 이에 대한 장점이 줄어들었다.

하지만 플래시 메모리는 [페이지에 1 byte라도 쓰기 위해서는 전체 페이지를 물리적 위치에 다시 써야 하는 특성](../Storage/Physical%20Storage%20System/Flash%20Memory.md##쓰기%20제한)이 있다. LSM 트리는 인덱스의 쓰기 행위의 횟수와 범위를 줄여주기에 플래시 기반 저장장치의 수명 연장과 성능 향상에도 여전히 유리한 구조이다.