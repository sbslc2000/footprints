---
상위 개념: "[[../Database|Database]]"
---
# Schema Migration
애플리케이션의 수명 주기 동안 데이터베이스 구조는 변경되기 마련이다. 스키마 마이그레이션(Schema Migration, Schema Versioning, 혹은 Database Migration이라고도 부름)이란 데이터베이스 스키마에 발생하는 **변경 사항을 관리하고 적용하는 일련의 과정**을 의미한다. 

데이터베이스 마이그레이션 기법을 사용한다면 데이터베이스의 구조는 버전 관리 시스템에 의해 추적되어 점진적인 변경 사항을 파악할 수 있다. 

## Manual vs Automated Migration
**수동 마이그레이션**(Manual Migration)은 개발자가 직접 SQL DDD 또는 DML 스크립트를 작성하고, 데이터베이스 클라이언트 도구를 사용하여 각 환경에 수동으로 실행하는 방법을 뜻한다.

이는 개발자가 모든 스크립트 실행 과정을 제어하며, 작은 프로젝트에서 간단하게 시작할 때에 유리하다. 하지만 개발자의 손을 거치는 과정에서 스크립트가 누락되거나, 실행 순서가 잘못되는 등 오류가 발생할 가능성이 높다. 또한 이러한 스크립트를 누가 언제 실행했는지에 대한 이력을 추적하기 어렵고, 문제 발생 시 롤백하기에 어렵다는 단점이 있다.

반면 Flyway, Liquibase와 같은 데이터베이스 마이그레이션 도구를 사용하여 스크립트를 관리하는 방식을 **자동화된 마이그레이션**(Automated Migration)이라고 한다. 일반적으로 애플리케이션이 시작되거나 CI/CD 파이프라인에서 자동으로 마이그레이션을 수행한다.

## Unidirectional vs Bidirectional Migration
스키마 변경을 관리하는 두 가지의 철학이 존재한다.

첫 번째 철학은 **단방향 마이그레이션**(Unidirectional Migration)이다. 단방향 마이그레이션 방식에서 데이터베이스 스키마의 변경은 마치 시간처럼 항상 앞으로만 진행되어야 한다. 한번 적용된 마이그레이션은 불변하다고 간주하며, 이전 상태로 되돌리는 직접적인 undo 작업은 제공하지 않는다.

스키마 변경이 생길 때마다 새로운 버전의 스크립트가 추가되며(V1, V2, V3), 만약 V3에 문제가 있는 경우 V3을 롤백하는 것이 아니라 V3에 대한 undo 작업을 수행하는 V4 스크립트를 만들어 대응한다.

두 번째 철학은 **양방향 마이그레이션**(Bidirectional Migration)이다. 양방향 마이그레이션 방식은 각 데이터베이스 변경이 앞으로 나아가는(up) 작업과 뒤로 되돌리는(down) 작업 모두를 가질 수 있다고 간주한다. 즉, 언제든지 이전 상태로 되돌릴 수 있는 기능을 명시적으로 제공한다.

양방향 마이그레이션에서 각 버전은 변경을 적용하는 스크립트와 그 변경을 되돌리는 롤백 스크립트가 함께 정의되어야 한다. 해당 버전이 적용되는 경우 적용 스크립트가, 롤백되는 경우에만 롤백 스크립트가 수행된다.

하지만 특정 버전이 롤백될 때, 그 결과가 해당 버전의 적용 이후에 적용된 다른 버전의 스크립트와 충돌한다면 어떻게 될까? 예를 들어 V30에는 Member 테이블에 age라는 필드를 추가했고, V31에는 age 필드에 인덱스를 생성했을 수 있다. 이 경우 V30의 롤백 스크립트를 수행하는 것은 스키마 불일치에 의한 데이터베이스 오류를 야기할 수 있다.

이러한 복잡성 때문에 대부분의 프로덕션 시스템에서는 단방향 마이그레이션을 사용하는 것이 더 안전하다고 여기며 이를 선호한다.

