---
상위 개념: "[[트랜잭션과 락]]"
---
# JPA에서 격리 수준 높이기
JPA에서는 데이터베이스 트랜잭션 격리 수준을 READ COMMITTED로 가정한다. 만약 일부 로직에 더 높은 격리 수준이 필요한 경우 Optimistic Lock이나 Pessimistic Lock 중 하나를 사용할 수 있다.

## Optimistic Lock
**Optimistic Lock**(낙관적 락)은 트랜잭션 대부분은 충돌이 발생하지 않는다고 낙관적으로 가정하는 방법이다. 이 때에는 데이터베이스가 제공하는 락 기능을 사용하지 않고 JPA가 제공하는 버전 관리 기능을 사용한다. 낙관적 락 방식에서는 트랜잭션을 커밋하기 전 까지는 트랜잭션의 충돌을 알 수 없다.

## Pessimistic Lock
**Pessimistic Lock**(비관적 락)은 트랜잭션의 충돌이 발생한다고 가정하고 우선 락을 걸고 보는 방법이다. select for update와 같은 데이터베이스가 제공하는 락 기능을 사용한다.

## Second Lost Updates Problems
**Second Lost Updates Problem**(두 번의 갱신 분실 문제)는 데이터베이스 트랜잭션의 범위를 넘어서는 문제이다. 예를 들어 사용자 A와 B가 동시에 특정 글의 제목을 수정한다고 가정해보자. A와 B가 동시에 수정화면을 연 뒤 값을 변경하고, A가 먼저 값을 저장하고 이후 B가 값을 저장했다. 이 경우 A의 수정사항은 사라지고 나중에 완료한 사용자 B의 수정사항만 남게 된다.

이러한 문제를 해결하는 것은 트랜잭션으로만은 불가능하다. 이 때에는 3가지 선택 방법이 있다.

1. 마지막 커밋만 인정하기
2. 최초 커밋만 인정하기
3. 충돌하는 갱신 내용 병합하기

기본적으로는 1번이 사용되지만, 상황에 따라 2번이 더 합리적일 수 있다. JPA가 제공하는 버전 관리 기능을 사용하면 손쉽게 최초 커밋만 인정하기를 구현할 수 있다.