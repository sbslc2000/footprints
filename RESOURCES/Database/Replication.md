---
상위 링크: "[[Database]]"
---
# Replication
Replication이란 네트워크로 연결된 스토리지 노드가 동일한 데이터 복사를 유지하는 것을 의미하며, 고가용성 읽기, 쓰기 처리량 증가, 지리적 응답 지연 감소 등을 위해 사용할 수 있다.

## Terminologies
* Replica : 각 복사본을 가지고 있는 노드
* Replica Set : 복사본들의 집합

## Leader-follower 복제
복제를 유지하는 방법 중 가장 일반적인 방법은 Leader와 Follower를 결정하는 방법이다. Leader-based, Leader-Follower, Active-Passive, Master-Slave 라고도 불린다.

운영 방법마다 다르지만 일반적으로 Leader는 데이터를 쓰기만 하고, Follower는 읽기만 수행하는 구조로 만든다. 

복제를 수행하는 방법은 구현마다 다를 수 있으며, 복제 로그 혹은 stream을 통해서 수행한다.

### 동기 vs 비동기 복제
복제 입장에서 동기와 비동기 방식은 다른 레플리카에 복제가 되는 타이밍을 기준으로 구분된다.

동기 방식은 모든 레플리카 셋이 최신 데이터를 저장하는 것을 보장하므로, 리더 노드 장애시 다른 노드로 전환하는 것이 비교적 간단하다. 하지만 기본적으로 느릴 수 밖에 없으며, 특정 레플리카에 장애가 나면 쓰기가 중단되는 단점이 있어 비현실적인 방안일 수 있다.

비동기 복제는 가용성 측면에서 장점이 있으나, 모든 레플리카에 최신 데이터가 있는지 보장할 수 없다. 따라서 일반적으로는 동기와 비동기 방식을 적절히 혼합한 방법을 사용하여 복제를 수행한다.

### 새로운 팔로워 추가시 필요한 과정

1. 리더 노드의 Snapshot을 복사하여 새로운 팔로워 노드에 저장
2. 리더 노드에게 snapshot 이후의 데이터 변경 내역(백로그)를 요청
3. 백로그 처리 이후에 발생하는 리더의 변경을 팔로워에 적용하여 동기화

## 고가용성 유지 방식 - 자동 복구

1. **리더 상태 판단** : HeartBeat 등을 사용하여 리더 노드의 상태를 판단한다.
2. **새로운 리더 선출** : 리더 노드가 장애로 판단되면, 새로운 리더를 선출한다. 이 과정은 제어 노드Control Node에 의해 리더를 지정하거나 참여중인 노드 사이의 선거를 거치게 된다. 가장 최신 데이터를 가지고 있는 노드가 가장 적합한 리더로 선택된다.
3. **시스템 재설정**: 클라이언트가 새로운 리더 노드에 쓰기 요청을 보낼 수 있도록 Request Routing처리를 하며, 이전 리더 노드가 시스템 변경을 인식하도록 해야 한다.

### 문제점
